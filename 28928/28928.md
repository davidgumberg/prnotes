# [#28928](https://github.com/bitcoin/bitcoin/pull/28928/): Add coverage for bech32m in `wallet_keypool_topup`
All code comments in `[]` are my own.

<details>

<summary> Bech32m </summary>

Bech32m is an output encoding scheme introduced in [BIP350](https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki) (December 2020)
to replace [Bech32](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki)(March 2017).

### Bech32

- Is a general encoding format that replaces base58 output/address encoding.
    - The address encoding format originally shipped with Bitcoin.
    - 58 alphanumeric symbols. (0OIl are excluded for being hard to tell apart)
    - Includes a version byte prefix and a four byte SHA256-based checksum postfixed.
    - Addresses are Base58 encoding of `Version byte || Payload bytes || (SHA256(SHA256(Version || Payload)))[0:3]`
    - Example Base58 encoded P2PKH: `1AKDDsfTh8uY4X3ppy1m7jw1fVMBSMkzjP`
- Rationale for Bech32:
    > - Base58 needs a lot of space in QR codes, as it cannot use the alphanumeric mode.
    > - The mixed case in base58 makes it inconvenient to reliably write down, type on mobile keyboards, or read out loud.
    > - The double SHA256 checksum is slow and has no error-detection guarantees.
    > - Most of the research on error-detecting codes only applies to character-set sizes that are a prime power, which 58 is not.
    > - Base58 decoding is complicated and relatively slow.
- Bech32 is all lowercase.
- Uses a BCH code for error detection
    - TODO: How does BCH work?
- Consists of a human readable part which is meant to convey the type of data
  encoded, a separator ('1') and the data part (with a 6-character checksum at the end.)
    - The data part uses uncased alphanumeric characters, excluding '1', 'b', 'i' and 'o',
      hence Bech**32**.
- Bech32 segwit address format
    - As mentioned above, Bech32 can be used to encode arbitrary data, [BIP173 specifies](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki#segwit-address-format)
      a format for encoding segwit v0 addresses that is built on top of Bech32.
    - The human readable part must be 'bc' for mainnet or 'tb' for testnet'
    - The first decoded data value representing the witness version must be between 0 and 16,
      inclusive.
    - The rest of the data is the '2-to-40 byte witness program [as defined by BIP141](https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#witness-program)'
      formatted according to the following rules:
        - Starting with the bits of the witness program, most significant bit per byte first:
            - Arrange the bits into groups of 5, and pad with zeroes at the end if needed.
            - Translate the groups of 5 bits to their Bech32 characters.
        - Even though the witness program can be 2 to 40 bytes long, the version 0 
          witness program specified in BIP141, can only consist of 20 or 32 bytes.
    - Followed by the Bech32 checksum.
- Example Bech32 encoded segwit output: `bc1zw508d6qejxtdg4y5r3zarvaryvg6kdaj`

### Bech32m
- Replaces Bech32 because of a weakness in the checksum format, where if the final character
  of a Bech32 string is `p`, inserting or deleting any number of `q` characters immediately
  preceding it does not invalidate the checksum.
    - [For example](https://github.com/sipa/bech32/issues/51):
       - `ii2134hk2xmat79tqp`
       - `ii2134hk2xmat79tqqp`
       - `ii2134hk2xmat79tqqqp`
       - `ii2134hk2xmat79tqqqqp`
      are all valid Bech32 strings.
    - Due to the two possible lengths of Witness Version 0 Bech32 addresses
      [specified in BIP173](https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#witness-program)
      , Version 0 Segwit addresses are not vulnerable to this weakness.
- BIP 173 [proposes](https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki#addresses-for-segregated-witness-outputs)
  that Version 0 outputs continue to use Bech32, and addresses with witness versions 1 or
  greater be encoded using Bech32m.

- TODO: What is the flaw in Bech32's checksum, and how does Bech32m fix it?
    > Bech32m modifies the checksum of the Bech32 specification, replacing the constant 1 that is xored into the checksum at the end with 0x2bc830a3. [BIP350](https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki#bech32m)

</details>

## [test: add coverage for Bech32m in wallet_keypool_topup](https://github.com/bitcoin/bitcoin/pull/28928/commits/d5753bc18a632f5593d01b6c35af2bc72339f625)


## [test: use multiple wallets instead of nodes in `wallet_keypool_topup`](https://github.com/bitcoin/bitcoin/pull/28928/commits/656dddb47e5ed5e7240d548a9db135d012f61653)
